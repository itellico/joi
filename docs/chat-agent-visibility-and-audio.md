# Chat Agent Visibility And Audio

## Why you do not see the agent badge

Two conditions must be true:

1. Gateway must send agent metadata:
   - `JOI_AGENT_VISIBILITY=1`
   - See: `gateway/src/server.ts` around `chat.routed` and `chat.done` (`agentVisibility` gate).
2. The message must be handled by a non-`personal` agent:
   - UI intentionally hides badge for `personal`.
   - See: `web/src/components/AssistantChat.tsx` (`showAgentBadge = message.agentId && message.agentId !== "personal"`).

Also, in chat page submit path, user messages are sent with `agentId: "personal"` and rely on router override:
- See: `web/src/pages/Chat.tsx` (`sendMessage(input.trim(), chatMode, "personal")`).

## Why no audio is heard in this chat

`chatMode: "api"` is text chat, not voice playback.

Audio playback is handled by LiveKit voice session flow (`useVoiceSession`), not by normal WS `chat.send` turns:
- See: `web/src/hooks/useVoiceSession.ts`
- Voice endpoint: `POST /api/voice/chat` in `gateway/src/server.ts`

## Error: "JSON error injected into SSE stream"

This exact text is not hardcoded in repository source.  
The UI shows it because `chat.error` frames are rendered as system messages:
- See: `web/src/hooks/useChat.ts` (`on("chat.error")` => `content: "Error: ..."`)

So this message is being forwarded from a lower-level exception (provider/tool streaming path), not generated by static app text.

## Quick checklist

1. Set `JOI_AGENT_VISIBILITY=1` and restart gateway.
2. Ensure `JOI_INTENT_ROUTER=1` if you want auto-routing to specialist agents.
3. For audio, use voice mode/session (LiveKit), not plain API chat mode.
4. If SSE JSON error repeats, capture gateway logs around `Error handling chat.send` and provider stream errors for one failing request.
